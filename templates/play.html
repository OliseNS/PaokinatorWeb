{% extends "layout.html" %}

{% block content %}

<div id="game-content">

    {% if data.should_guess and data.guess %}
        <h2>My Guess Is...</h2>
        <h1 class="glow-text">Is it a {{ data.guess }}?</h1>
        <p>I'm feeling pretty confident about this one!</p>

        <form action="{{ url_for('guess_result') }}" method="POST" style="display: flex; flex-direction: column; align-items: center; gap: 12px; width: 100%;">
            <input type="hidden" name="guess" value="{{ data.guess }}">
            <button type="submit" name="response" value="yes" class="btn btn-primary">That's Right!</button>
            <button type="submit" name="response" value="no" class="btn">No, that's wrong</button>
        </form>

    {% elif data.question and data.feature %}
        <h2>Question {{ data.question_number }}</h2>
        <h1 class="glow-text">{{ data.question }}</h1>

        <input type="hidden" id="feature-input" name="feature" value="{{ data.feature }}">
        
        {% if data.is_sneaky_guess %}
            <input type="hidden" id="animal-name-input" name="animal_name" value="{{ data.animal_name }}">
        {% endif %}

        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; max-width: 450px; margin: 0 auto;">
            <button type="button" name="answer" value="yes" class="btn" style="padding: 12px 16px;">Yes</button>
            <button type="button" name="answer" value="usually" class="btn" style="padding: 12px 16px;">Usually</button>
            <button type="button" name="answer" value="sometimes" class="btn" style="padding: 12px 16px; grid-column: 1 / -1;">Sometimes / Maybe</button>
            <button type="button" name="answer" value="rarely" class="btn" style="padding: 12px 16px;">Rarely</button>
            <button type="button" name="answer" value="no" class="btn" style="padding: 12px 16px;">No</button>
        </div>

        <div class="skip-container">
            <button type="button" name="answer" value="skip" class="btn-skip">
                Skip Question →
            </button>
            <br>
            <button type="button" class="btn-report" onclick="alert('Reporting feature coming soon!')">
                <i class="fa-regular fa-flag"></i> Report Question
            </button>
        </div>
    
    {% else %}
        <h2>Oh no!</h2>
        <p>I seem to have run out of questions. You've stumped me!</p>
        <div style="display: flex; justify-content: center; width: 100%;">
            <a href="{{ url_for('is_it_this') }}" class="btn btn-primary">Let's see what you had in mind...</a>
        </div>
    {% endif %}

</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const gameContent = document.getElementById('game-content');
    const overlay = document.getElementById('loading-overlay');
    const apiAnswerUrl = "{{ url_for('api_answer') }}";

    gameContent.addEventListener('click', (event) => {
        const target = event.target;
        if (target.tagName === 'BUTTON' && target.name === 'answer') {
            handleAnswerClick(target.value);
        }
    });

    async function handleAnswerClick(answerValue) {
        if (!overlay) return;
        
        overlay.classList.add('visible');

        const featureEl = document.getElementById('feature-input');
        const animalNameEl = document.getElementById('animal-name-input');

        if (!featureEl) {
            overlay.classList.remove('visible');
            return;
        }

        const payload = {
            answer: answerValue,
            feature: featureEl.value,
            animal_name: animalNameEl ? animalNameEl.value : null
        };

        try {
            const response = await fetch(apiAnswerUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`Server error: ${response.statusText}`);
            }

            const newData = await response.json();

            if (newData.redirect_url) {
                window.location.href = newData.redirect_url;
                return;
            }

            renderGameUpdate(newData);

        } catch (error) {
            console.error('Fetch error:', error);
            gameContent.innerHTML = `<p style="color: red;">An error occurred. Please <a href="{{ url_for('index') }}">start over</a>.</p>`;
        } finally {
            setTimeout(() => {
                if (overlay) {
                    overlay.classList.remove('visible');
                }
            }, 100); 
        }
    }

    function renderGameUpdate(data) {
        let newHtml = '';

        if (data.should_guess && data.guess) {
            newHtml = `
                <h2>My Guess Is...</h2>
                <h1 class="glow-text">Is it a ${escapeHTML(data.guess)}?</h1>
                <p>I'm feeling pretty confident about this one!</p>
                <form action="{{ url_for('guess_result') }}" method="POST" style="display: flex; flex-direction: column; align-items: center; gap: 12px; width: 100%;">
                    <input type="hidden" name="guess" value="${escapeHTML(data.guess)}">
                    <button type="submit" name="response" value="yes" class="btn btn-primary">That's Right!</button>
                    <button type="submit" name="response" value="no" class="btn">No, that's wrong</button>
                </form>
            `;
        } else if (data.question && data.feature) {
            const sneakyGuessHtml = data.is_sneaky_guess
                ? `<input type="hidden" id="animal-name-input" name="animal_name" value="${escapeHTML(data.animal_name)}">`
                : '';

            newHtml = `
                <h2>Question ${data.question_number}</h2>
                <h1 class="glow-text">${escapeHTML(data.question)}</h1>
                
                <input type="hidden" id="feature-input" name="feature" value="${escapeHTML(data.feature)}">
                ${sneakyGuessHtml}

                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; max-width: 450px; margin: 0 auto;">
                    <button type="button" name="answer" value="yes" class="btn" style="padding: 12px 16px;">Yes</button>
                    <button type="button" name="answer" value="usually" class="btn" style="padding: 12px 16px;">Usually</button>
                    <button type="button" name="answer" value="sometimes" class="btn" style="padding: 12px 16px; grid-column: 1 / -1;">Sometimes / Maybe</button>
                    <button type="button" name="answer" value="rarely" class="btn" style="padding: 12px 16px;">Rarely</button>
                    <button type="button" name="answer" value="no" class="btn" style="padding: 12px 16px;">No</button>
                </div>
                
                <div class="skip-container">
                    <button type="button" name="answer" value="skip" class="btn-skip">
                        Skip Question →
                    </button>
                    <br>
                    <button type="button" class="btn-report" onclick="alert('Reporting feature coming soon!')">
                        <i class="fa-regular fa-flag"></i> Report Question
                    </button>
                </div>
            `;
        } else {
            newHtml = `
                <h2>Oh no!</h2>
                <p>I seem to have run out of questions. You've stumped me!</p>
                <div style="display: flex; justify-content: center; width: 100%;">
                    <a href="{{ url_for('is_it_this') }}" class="btn btn-primary">Let's see what you had in mind...</a>
                </div>
            `;
        }
        if (gameContent) {
            gameContent.innerHTML = newHtml;
        }
    }
    
    function escapeHTML(str) {
        if (str === null || str === undefined) return '';
        return str.toString()
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }
});
</script>

{% endblock %}