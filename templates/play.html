{% extends "layout.html" %}

{% block content %}

<div id="game-content">

    {% if data.should_guess and data.guess %}
        <h2>My Guess Is...</h2>
        <h1 class="glow-text">Is it a {{ data.guess }}?</h1>
        <p>I'm feeling pretty confident about this one!</p>

        <div id="guess-form" style="display: flex; flex-direction: column; align-items: center; gap: 12px; width: 100%;">
            <input type="hidden" id="guess-input" name="guess" value="{{ data.guess }}">
            <button type="button" id="guess-yes" name="response" value="yes" class="btn btn-primary">That's Right!</button>
            <button type="button" id="guess-no" name="response" value="no" class="btn">No, that's wrong</button>
        </div>

    {% elif data.question and data.feature %}
        <h2>Question {{ data.question_number }}</h2>
        <h1 class="glow-text">{{ data.question }}</h1>

        <input type="hidden" id="feature-input" name="feature" value="{{ data.feature }}">
        
        {% if data.is_sneaky_guess %}
            <input type="hidden" id="animal-name-input" name="animal_name" value="{{ data.animal_name }}">
        {% endif %}

        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; max-width: 450px; margin: 0 auto;">
            <button type="button" name="answer" value="yes" class="btn" style="padding: 12px 16px;">Yes</button>
            <button type="button" name="answer" value="usually" class="btn" style="padding: 12px 16px;">Usually</button>
            <button type="button" name="answer" value="sometimes" class="btn" style="padding: 12px 16px; grid-column: 1 / -1;">Sometimes / Maybe</button>
            <button type="button" name="answer" value="rarely" class="btn" style="padding: 12px 16px;">Rarely</button>
            <button type="button" name="answer" value="no" class="btn" style="padding: 12px 16px;">No</button>
        </div>

        <div class="skip-container">
            {% if data.question_number != 1 %}
            <button type="button" id="btn-undo" class="btn-skip" style="color: #666;">
                <i class="fa-solid fa-rotate-left"></i> Undo
            </button>
            {% endif %}
            <button type="button" name="answer" value="skip" class="btn-skip">
                Skip Question →
            </button>
            </div>
    
    {% else %}
        <h2>Oh no!</h2>
        <p>I seem to have run out of questions. You've stumped me!</p>
        <div style="display: flex; justify-content: center; width: 100%;">
            <a href="{{ url_for('is_it_this') }}" class="btn btn-primary">Let's see what you had in mind...</a>
        </div>
    {% endif %}

</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const gameContent = document.getElementById('game-content');
    const overlay = document.getElementById('loading-overlay');
    
    // API URLs from Flask
    const apiAnswerUrl = "{{ url_for('api_answer') }}";
    const apiRejectUrl = "{{ url_for('api_reject_guess') }}";
    const apiContinueUrl = "{{ url_for('api_continue_game') }}";
    const apiUndoUrl = "{{ url_for('api_undo') }}"; // ADDED: Undo API URL
    
    // Redirect URLs from Flask
    const winRedirectUrl = (animal) => `{{ url_for('confirm_win_route', animal='ANIMAL_PLACEHOLDER') }}`.replace('ANIMAL_PLACEHOLDER', animal);
    const isItThisRedirectUrl = "{{ url_for('is_it_this') }}";
    const startOverRedirectUrl = "{{ url_for('index') }}";

    // Use event delegation for all buttons inside gameContent
    gameContent.addEventListener('click', (event) => {
        const target = event.target.closest('button');
        if (!target) return; // Click wasn't on a button

        const buttonName = target.name;
        const buttonId = target.id;

        if (buttonName === 'answer') {
            // Handle question answers (Yes, No, Sometimes, etc.)
            handleAnswerClick(target.value);
        } else if (buttonId === 'guess-yes') {
            // Handle "That's Right!"
            handleGuessYesClick();
        } else if (buttonId === 'guess-no') {
            // Handle "No, that's wrong"
            handleGuessNoClick();
        } else if (buttonId === 'continue-yes') {
            // Handle "Continue? - Yes"
            handleContinueYesClick();
        } else if (buttonId === 'continue-no') {
            // Handle "Continue? - No"
            handleContinueNoClick();
        } else if (buttonId === 'btn-undo') { // ADDED: Undo click handler
            // Handle "Undo"
            handleUndoClick();
        }
    });

    // --- Button Handler Functions ---

    async function handleAnswerClick(answerValue) {
        showLoading();
        const featureEl = document.getElementById('feature-input');
        const animalNameEl = document.getElementById('animal-name-input');

        if (!featureEl) {
            showError('Game state error. Please start over.');
            return;
        }

        const payload = {
            answer: answerValue,
            feature: featureEl.value,
            animal_name: animalNameEl ? animalNameEl.value : null
        };

        try {
            const data = await postData(apiAnswerUrl, payload);
            if (data.redirect_url) {
                window.location.href = data.redirect_url;
            } else {
                renderGameUpdate(data);
            }
        } catch (error) {
            showError(error.message);
        } finally {
            hideLoading();
        }
    }

    function handleGuessYesClick() {
        showLoading();
        const guessEl = document.getElementById('guess-input');
        const animal = guessEl ? guessEl.value : 'your animal';
        // This is a win, so we just redirect
        window.location.href = winRedirectUrl(animal);
    }

    async function handleGuessNoClick() {
        showLoading();
        const guessEl = document.getElementById('guess-input');
        if (!guessEl) {
            showError('Game state error. Please start over.');
            return;
        }

        const payload = { guess: guessEl.value };

        try {
            // Call the new /api/reject_guess endpoint
            const data = await postData(apiRejectUrl, payload);
            // The response will be {status: 'ask_to_continue', ...}
            // Pass this directly to renderGameUpdate
            renderGameUpdate(data);
        } catch (error) {
            showError(error.message);
        } finally {
            hideLoading();
        }
    }

    async function handleContinueYesClick() {
        showLoading();
        try {
            // Call the new /api/continue_game endpoint
            const data = await postData(apiContinueUrl, {});
            // This response will be the *next question*
            renderGameUpdate(data);
        } catch (error) {
            showError(error.message);
        } finally {
            hideLoading();
        }
    }

    function handleContinueNoClick() {
        showLoading();
        // User doesn't want to continue, redirect to the "is it this?" list
        window.location.href = isItThisRedirectUrl;
    }

    // ADDED: New function to handle Undo
    async function handleUndoClick() {
        showLoading();
        try {
            // Call the /api/undo endpoint
            const data = await postData(apiUndoUrl, {});
            
            if (data.error) {
                // Show a non-fatal error if undo fails (e.g., no more history)
                // You might want to flash a message instead
                alert(data.error);
            } else {
                // The response is the reverted game state
                renderGameUpdate(data);
            }
        } catch (error) {
            showError(error.message);
        } finally {
            hideLoading();
        }
    }

    // --- Utility Functions ---

    async function postData(url, payload) {
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`Server error: ${response.statusText}`);
            }
            return await response.json();
        } catch (error) {
            console.error('Fetch error:', error);
            throw new Error('Could not connect to the server. Please try again.');
        }
    }

    function renderGameUpdate(data) {
        let newHtml = '';

        // --- NEW: Handle 'ask_to_continue' status ---
        if (data.status === 'ask_to_continue') {
            newHtml = `
                <h2>Darn!</h2>
                <h1 class="glow-text">Do you want to continue?</h1>
                <p>I can ask a few more questions to try and get it right!</p>
                <div style="display: flex; flex-direction: row; justify-content: center; align-items: center; gap: 12px; width: 100%;">
                    <button type="button" id="continue-yes" class="btn btn-primary" style="flex: 1; max-width: 200px;">Yes, continue</button>
                    <button type="button" id="continue-no" class="btn" style="flex: 1; max-width: 200px;">No, you lost</button>
                </div>
            `;
        }
        // --- END NEW ---
        
        else if (data.should_guess && data.guess) {
            newHtml = `
                <h2>My Guess Is...</h2>
                <h1 class="glow-text">Is it a ${escapeHTML(data.guess)}?</h1>
                <p>I'm feeling pretty confident about this one!</p>
                <div id="guess-form" style="display: flex; flex-direction: column; align-items: center; gap: 12px; width: 100%;">
                    <input type="hidden" id="guess-input" name="guess" value="${escapeHTML(data.guess)}">
                    <button type="button" id="guess-yes" name="response" value="yes" class="btn btn-primary">That's Right!</button>
                    <button type="button" id="guess-no" name="response" value="no" class="btn">No, that's wrong</button>
                </div>
            `;
        } else if (data.question && data.feature) {
            const sneakyGuessHtml = data.is_sneaky_guess
                ? `<input type="hidden" id="animal-name-input" name="animal_name" value="${escapeHTML(data.animal_name)}">`
                : '';

            // Decide whether to show the Undo button based on question_number.
            // If question_number is exactly 1, do NOT show the Undo button.
            const showUndo = (typeof data.question_number === 'number' && data.question_number !== 1)
                             || (typeof data.question_number === 'string' && data.question_number !== '1');

            const undoHtml = showUndo
                ? `<button type="button" id="btn-undo" class="btn-skip" style="color: #666;">
                        <i class="fa-solid fa-rotate-left"></i> Undo
                   </button>`
                : '';

            newHtml = `
                <h2>Question ${escapeHTML(data.question_number)}</h2>
                <h1 class="glow-text">${escapeHTML(data.question)}</h1>
                
                <input type="hidden" id="feature-input" name="feature" value="${escapeHTML(data.feature)}">
                ${sneakyGuessHtml}

                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; max-width: 450px; margin: 0 auto;">
                    <button type="button" name="answer" value="yes" class="btn" style="padding: 12px 16px;">Yes</button>
                    <button type="button" name="answer" value="usually" class="btn" style="padding: 12px 16px;">Usually</button>
                    <button type="button" name="answer" value="sometimes" class="btn" style="padding: 12px 16px; grid-column: 1 / -1;">Sometimes / Maybe</button>
                    <button type="button" name="answer" value="rarely" class="btn" style="padding: 12px 16px;">Rarely</button>
                    <button type="button" name="answer" value="no" class="btn" style="padding: 12px 16px;">No</button>
                </div>
                
                <div class="skip-container">
                    ${undoHtml}
                    <button type="button" name="answer" value="skip" class="btn-skip">
                        Skip Question →
                    </button>
                    
                    </div>
            `;
        } else {
            // This is the "Game Over - Stumped" state
            newHtml = `
                <h2>Oh no!</h2>
                <p>I seem to have run out of questions. You've stumped me!</p>
                <div style="display: flex; justify-content: center; width: 100%;">
                    <a href="${isItThisRedirectUrl}" class="btn btn-primary">Let's see what you had in mind...</a>
                </div>
            `;
        }
        
        if (gameContent) {
            gameContent.innerHTML = newHtml;
        }
    }

    function showLoading() {
        if (overlay) overlay.classList.add('visible');
    }

    function hideLoading() {
        if (overlay) {
            // Add a small delay so the loader is visible for at least a moment
            setTimeout(() => {
                overlay.classList.remove('visible');
            }, 100);
        }
    }
    
    function showError(message) {
        console.error('Game Error:', message);
        if (gameContent) {
            gameContent.innerHTML = `<p style="color: red;">${escapeHTML(message)} Please <a href="${startOverRedirectUrl}">start over</a>.</p>`;
        }
        hideLoading();
    }
    
    function escapeHTML(str) {
        if (str === null || str === undefined) return '';
        return str.toString()
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }
});
</script>

{% endblock %}
