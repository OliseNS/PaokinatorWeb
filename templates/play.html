{% extends "layout.html" %}
{% from "_form_helpers.html" import render_answer_buttons %}

{% block content %}

<div id="game-content">

    {% if data.should_guess and data.guess %}
        <h2>My guess is...</h2>
        <h1 class="glow-text">Is it a {{ data.guess }}?</h1>
        <p>I'm feeling pretty confident about this one!</p>

        <div id="guess-form" style="display: flex; flex-direction: column; align-items: center; gap: 12px; width: 100%;">
            <input type="hidden" id="guess-input" name="guess" value="{{ data.guess }}">
            <button type="button" id="guess-yes" name="response" value="yes" class="btn btn-primary">That's Right!</button>
            <button type="button" id="guess-no" name="response" value="no" class="btn">No, that's wrong</button>
        </div>

    {% elif data.question and data.feature %}
        <h2>Question {{ data.question_number }}</h2>
        <h1 class="glow-text">{{ data.question }}</h1>

        <input type="hidden" id="feature-input" name="feature" value="{{ data.feature }}">
        
        {% if data.is_sneaky_guess %}
            <input type="hidden" id="animal-name-input" name="animal_name" value="{{ data.animal_name }}">
        {% endif %}

        {{ render_answer_buttons() }}

        <div class="skip-container">
            {% if data.question_number != 1 %}
            <button type="button" id="btn-undo" class="btn-skip" style="color: #666;">
                <i class="fa-solid fa-rotate-left"></i> Undo
            </button>
            {% endif %}
            {# The "I don't know" button is now rendered inside the macro #}
        </div>
    
    {% else %}
        <h2>Oh no!</h2>
        <p>I seem to have run out of questions. You've stumped me!</p>
        <div style="display: flex; justify-content: center; width: 100%;">
            <a href="{{ url_for('is_it_this') }}" class="btn btn-primary">Let's see what you had in mind...</a>
        </div>
    {% endif %}

</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const gameContent = document.getElementById('game-content');
    const overlay = document.getElementById('loading-overlay');
    
    const apiAnswerUrl = "{{ url_for('api_answer') }}";
    const apiRejectUrl = "{{ url_for('api_reject_guess') }}";
    const apiContinueUrl = "{{ url_for('api_continue_game') }}";
    const apiUndoUrl = "{{ url_for('api_undo') }}";
    
    const winRedirectUrl = (animal) => `{{ url_for('confirm_win_route', animal='ANIMAL_PLACEHOLDER') }}`.replace('ANIMAL_PLACEHOLDER', animal);
    const isItThisRedirectUrl = "{{ url_for('is_it_this') }}";
    const startOverRedirectUrl = "{{ url_for('index') }}";

    gameContent.addEventListener('click', (event) => {
        const target = event.target.closest('button');
        if (!target) return;

        const buttonName = target.name;
        const buttonId = target.id;

        if (buttonName === 'answer') {
            handleAnswerClick(target.value);
        } else if (buttonId === 'guess-yes') {
            handleGuessYesClick();
        } else if (buttonId === 'guess-no') {
            handleGuessNoClick();
        } else if (buttonId === 'continue-yes') {
            handleContinueYesClick();
        } else if (buttonId === 'continue-no') {
            handleContinueNoClick();
        } else if (buttonId === 'btn-undo') {
            handleUndoClick();
        }
    });

    async function handleAnswerClick(answerValue) {
        showLoading();
        const featureEl = document.getElementById('feature-input');
        const animalNameEl = document.getElementById('animal-name-input');

        if (!featureEl) {
            showError('Game state error. Please start over.');
            return;
        }

        const payload = {
            answer: answerValue,
            feature: featureEl.value,
            animal_name: animalNameEl ? animalNameEl.value : null
        };

        try {
            const data = await postData(apiAnswerUrl, payload);
            if (data.redirect_url) {
                window.location.href = data.redirect_url;
            } else {
                renderGameUpdate(data);
            }
        } catch (error) {
            showError(error.message);
        } finally {
            hideLoading();
        }
    }

    function handleGuessYesClick() {
        showLoading();
        const guessEl = document.getElementById('guess-input');
        const animal = guessEl ? guessEl.value : 'your animal';
        window.location.href = winRedirectUrl(animal);
    }

    async function handleGuessNoClick() {
        showLoading();
        const guessEl = document.getElementById('guess-input');
        if (!guessEl) {
            showError('Game state error. Please start over.');
            return;
        }

        const payload = { guess: guessEl.value };

        try {
            const data = await postData(apiRejectUrl, payload);
            renderGameUpdate(data);
        } catch (error) {
            showError(error.message);
        } finally {
            hideLoading();
        }
    }

    async function handleContinueYesClick() {
        showLoading();
        try {
            const data = await postData(apiContinueUrl, {});
            renderGameUpdate(data);
        } catch (error) {
            showError(error.message);
        } finally {
            hideLoading();
        }
    }

    function handleContinueNoClick() {
        showLoading();
        window.location.href = isItThisRedirectUrl;
    }

    async function handleUndoClick() {
        showLoading();
        try {
            const data = await postData(apiUndoUrl, {});
            
            if (data.error) {
                alert(data.error);
            } else {
                renderGameUpdate(data);
            }
        } catch (error) {
            showError(error.message);
        } finally {
            hideLoading();
        }
    }

    async function postData(url, payload) {
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`Server error: ${response.statusText}`);
            }
            return await response.json();
        } catch (error) {
            console.error('Fetch error:', error);
            throw new Error('Could not connect to the server. Please try again.');
        }
    }
    // This is the improved renderGameUpdate function to replace in play.html

    function renderGameUpdate(data) {
        let newHtml = '';

        if (data.status === 'ask_to_continue') {
            newHtml = `
                <h2>Darn!</h2>
                <h1 class="glow-text">Do you want to continue?</h1>
                <p>I can ask a few more questions to try and get it right!</p>
                <div style="display: flex; flex-direction: row; justify-content: center; align-items: center; gap: 12px; width: 100%;">
                    <button type="button" id="continue-yes" class="btn btn-primary" style="flex: 1; max-width: 200px;">Yes, continue</button>
                    <button type="button" id="continue-no" class="btn" style="flex: 1; max-width: 200px;">No, you lost</button>
                </div>
            `;
        }
        
        else if (data.should_guess && data.guess) {
            newHtml = `
                <h2>My guess is...</h2>
                <h1 class="glow-text">Is it a ${escapeHTML(data.guess)}?</h1>
                <p>I'm feeling pretty confident about this one!</p>
                <div id="guess-form" style="display: flex; flex-direction: column; align-items: center; gap: 12px; width: 100%;">
                    <input type="hidden" id="guess-input" name="guess" value="${escapeHTML(data.guess)}">
                    <button type="button" id="guess-yes" name="response" value="yes" class="btn btn-primary">That's Right!</button>
                    <button type="button" id="guess-no" name="response" value="no" class="btn">No, that's wrong</button>
                </div>
            `;
        } else if (data.question && data.feature) {
            const sneakyGuessHtml = data.is_sneaky_guess
                ? `<input type="hidden" id="animal-name-input" name="animal_name" value="${escapeHTML(data.animal_name)}">`
                : '';

            const showUndo = (typeof data.question_number === 'number' && data.question_number !== 1)
                            || (typeof data.question_number === 'string' && data.question_number !== '1');

            const undoHtml = showUndo
                ? `<button type="button" id="btn-undo" class="btn-skip">
                        <i class="fa-solid fa-rotate-left"></i> Undo
                </button>`
                : '';

            newHtml = `
                <h2>Question ${escapeHTML(data.question_number)}</h2>
                <h1 class="glow-text">${escapeHTML(data.question)}</h1>
                
                <input type="hidden" id="feature-input" name="feature" value="${escapeHTML(data.feature)}">
                ${sneakyGuessHtml}

                <div style="display: flex; flex-direction: column; gap: 12px; max-width: 400px; margin: 0 auto; width: 100%;">
                    <!-- Primary answers in a 2-column grid -->
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        <button type="button" name="answer" value="yes" class="btn" style="padding: 14px 16px;">Yes</button>
                        <button type="button" name="answer" value="no" class="btn" style="padding: 14px 16px;">No</button>
                    </div>
                    
                    <!-- Middle ground answers in a 2-column grid -->
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        <button type="button" name="answer" value="usually" class="btn" style="padding: 14px 16px;">Usually</button>
                        <button type="button" name="answer" value="rarely" class="btn" style="padding: 14px 16px;">Rarely</button>
                    </div>
                    
                    <!-- Partly as its own full-width button -->
                    <button type="button" name="answer" value="sometimes" class="btn" style="padding: 14px 16px;">Partly</button>
                    
                    <!-- Separator line -->
                    <div style="border-top: 1px solid #e5e5e5; margin: 8px 0;"></div>
                    
                    <!-- "I don't know" button - visually separated and distinct -->
                    <button type="button" name="answer" value="skip" class="btn" style="padding: 14px 16px; background-color: #f8f9fa; color: #666; border-color: #e0e0e0;">
                        <i class="fa-solid fa-circle-question" style="margin-right: 6px;"></i>I don't know
                    </button>
                </div>

                <div class="skip-container">
                    ${undoHtml}
                </div>
            `;
        } else {
            newHtml = `
                <h2>Oh no!</h2>
                <p>I seem to have run out of questions. You've stumped me!</p>
                <div style="display: flex; justify-content: center; width: 100%;">
                    <a href="${isItThisRedirectUrl}" class="btn btn-primary">Let's see what you had in mind...</a>
                </div>
            `;
        }
        
        if (gameContent) {
            gameContent.innerHTML = newHtml;
        }
    }
        
    function showLoading() {
        if (overlay) overlay.classList.add('visible');
    }

    function hideLoading() {
        if (overlay) {
            setTimeout(() => {
                overlay.classList.remove('visible');
            }, 100);
        }
    }
    
    function showError(message) {
        console.error('Game Error:', message);
        if (gameContent) {
            gameContent.innerHTML = `<p style="color: red;">${escapeHTML(message)} Please <a href="${startOverRedirectUrl}">start over</a>.</p>`;
        }
        hideLoading();
    }
    
    function escapeHTML(str) {
        if (str === null || str === undefined) return '';
        return str.toString()
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }
});
</script>

{% endblock %}